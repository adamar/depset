#!/bin/bash
#
# Example:
# 
#   "github.com/stretchr/testify"
#
# should become:
#
#   testify "github.com/stretchr/testify-9a3bde9" //depset
#

set -e


usage() { 
cat<<EOF

    DepSet

    Usage:
      depset [commands]

    Commands:

      freeze - Save all dependencies to current version and 
               alias all imports


EOF

}


_init() {

  if [ -z "$GOROOT" ]; then
    echo "GOROOT not set"
    exit 1
  fi

  if [ -z "$GOPATH" ]; then
    echo "GOPATH not set"
    exit 1
  fi

}




_listdeps() {

  local FILENAME="${1}"

  deps=($(grep "github.com\|gopkg.in\|code.google.com\|bitbucket.org\|azul3d.org" ${FILENAME} | sed -e 's/\"//' -e 's/\"//'))

  for dep in "${deps[@]}"
  do
    new_import_path=`_freeze_dep ${dep}`
    echo "change to $new_import_path"
  done

}


_show_git_root() {

  cd $1
  base=`git rev-parse --show-toplevel`
  echo $base
  
}


_get_short_hash() {

  cd $1
  hash=`git rev-parse --short HEAD`
  echo $hash

}


_freeze_dep() {

  local import="${1}"
  local fullpath="${GOPATH}/src/${1}"

  if [[ ! -d ${fullpath} ]]; then
    go get ${import}
  fi

  root=$(_show_git_root "${fullpath}")
  shorthash=$(_get_short_hash "${fullpath}")   

  cp -r "${GOPATH}/src/${import}" "${GOPATH}/src/${import}-${shorthash}"
  echo "${import}-$shorthash"

}


freeze() {
  _init
  for i in `find . -type f -iname '*.go'`;
  do
    _listdeps $i
  done
}


case "$1" in
  freeze)
    echo "Freezing"
    freeze
    ;;
  usage)
    usage
    ;;
  *)
    echo "Unknown option $1"
    usage
    ;;
esac

