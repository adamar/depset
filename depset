#!/bin/bash
#
# Example:
# 
#   "github.com/stretchr/testify"
#
# should become:
#
#   testify "github.com/stretchr/testify-9a3bde9" //depset
#

set -e


usage() { 
cat<<EOF

    DepSet

    Usage:
      depset [commands]

    Commands:

      freeze - Save all dependencies to current version and 
               alias all imports


EOF

}


_init() {

  if [ -z "$GOROOT" ]; then
    echo "GOROOT not set"
    exit 1
  fi

  if [ -z "$GOPATH" ]; then
    echo "GOPATH not set"
    exit 1
  fi

}




_listdeps() {

  deps=($(grep "github.com\|gopkg.in\|code.google.com\|bitbucket.org\|azul3d.org" ${1} | sed -e 's/\"//' -e 's/\"//'))

  for dep in "${deps[@]}"
  do
    _freeze_dep ${dep}
  done

}


_show_git_root() {

  cd $1
  base=`git rev-parse --show-toplevel`
  echo $base
  
}


_get_short_hash() {

  cd $1
  hash=`git rev-parse --short HEAD`
  echo $hash

}


_freeze_dep() {

  import="${1}"
  fullpath="${GOPATH}/src/${1}"

  echo "Searching for ${fullpath}"
  if [ -d "${fullpath}" ]; then
    root=$(_show_git_root "${fullpath}")
    echo "Git root is $root"
    shorthash=$(_get_short_hash "${fullpath}")   
    echo $shorthash
  else
    echo "not found" 
  fi

}


freeze() {

_init
_listdeps $1

}


case "$1" in
  freeze)
    echo "Freezing"
    freeze
    ;;
  usage)
    usage
    ;;
  *)
    echo "Unknown option $1"
    usage
    ;;
esac

